# FILE: deployment.yaml.vm
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${deploymentName}
  namespace: ${namespace}
  labels:
    app: ${appLabel}
    app.kubernetes.io/component: session
    app.kubernetes.io/part-of: theia-cloud
    theia-cloud.io/app-definition: ${appDefinitionName}
    theia-cloud.io/session: ${sessionName}
    theia-cloud.io/user: ${user}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${appLabel}
  template:
    metadata:
      labels:
        app: ${appLabel}
        app.kubernetes.io/component: session
        app.kubernetes.io/part-of: theia-cloud
        theia-cloud.io/app-definition: ${appDefinitionName}
        theia-cloud.io/session: ${sessionName}
        theia-cloud.io/user: ${user}
      annotations:
#if( $downlinkLimit )
          kubernetes.io/ingress-bandwidth: "${downlinkLimit}k"
#end
#if( $uplinkLimit )
          kubernetes.io/egress-bandwidth: "${uplinkLimit}k"
#end
    spec:
      automountServiceAccountToken: false
      serviceAccount: designer
      serviceAccountName: designer
      securityContext:
        fsGroup: ${fsGroupUid}
#if( $pullSecret )
      imagePullSecrets:
        - name: ${pullSecret}
#end
      volumes:
        - name: workspace
          persistentVolumeClaim:
            claimName: ${pvcName}
        - name: oauth2-proxy-config
          configMap:
            name: ${oauth2ProxyConfigMapName}
        - name: oauth2-templates
          configMap:
            name: ${oauth2TemplatesConfigMapName}
        - name: oauth2-emails
          configMap:
            name: ${oauth2EmailsConfigMapName}

      containers:

        # --- oauth2-proxy sidecar (fronts Theia) ---
        - name: oauth2-proxy
          image: ${oauth2ProxyImage}
          imagePullPolicy: IfNotPresent
          args:
            - --config=/etc/oauth2-proxy.cfg
            - --authenticated-emails-file=/emails/authenticated-emails-list
            - --gcp-healthchecks
            - --reverse-proxy
            - --skip-auth-route=/monitor/*
          ports:
            - containerPort: 5000
              name: web
              protocol: TCP
          volumeMounts:
            - name: oauth2-proxy-config
              mountPath: /etc/oauth2-proxy.cfg
              subPath: oauth2-proxy.cfg
            - name: oauth2-templates
              mountPath: /templates
            - name: oauth2-emails
              mountPath: /emails

        # --- Main Theia application container ---
        - name: ${appDefinitionName}
          image: ${image}
          imagePullPolicy: ${imagePullPolicy}
          ports:
          - containerPort: ${port}
            name: application
            protocol: TCP
#if( $monitorPort )
          - containerPort: ${monitorPort}
            name: monitor
#end
          resources:
            requests:
              cpu: ${requestsCpu}
              memory: ${requestsMemory}
            limits:
              cpu: ${limitsCpu}
              memory: ${limitsMemory}
          env:
#foreach($env in $envs)
              - name: $env.name
                value: "$env.value"
#end
          # pull envs from configmaps/secrets defined in Session spec
#if( $envVarsFromConfigMaps || $envVarsFromSecrets )
          envFrom:
#foreach($cm in $envVarsFromConfigMaps)
              - configMapRef:
                  name: $cm
#end
#foreach($sec in $envVarsFromSecrets)
              - secretRef:
                  name: $sec
#end
#end
          volumeMounts:
            - name: workspace
              mountPath: ${mountPath}
          securityContext:
            runAsUser: ${runAsUid}
            runAsGroup: ${runAsUid}
