## FILE: templates/theia-deployment.yaml.vm
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${deploymentName}
  namespace: ${namespace}
  labels:
    app: theia
    session-name: ${sessionName}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: theia
      session-name: ${sessionName}
  template:
    metadata:
      labels:
        app: theia
        session-name: ${sessionName}
        theia-cloud.io/app-definition: ${appDefinitionName}
        theia-cloud.io/session: ${sessionName}
        theia-cloud.io/user: ${user}
        theia-cloud.io/session-uid: ${sessionUid}
    annotations:
#if( $downlinkLimit )
        kubernetes.io/ingress-bandwidth: "${downlinkLimit}k"
#end
#if( $uplinkLimit )
        kubernetes.io/egress-bandwidth: "${uplinkLimit}k"
#end
    spec:
      automountServiceAccountToken: false
      securityContext:
        fsGroup: ${fsGroupUid}
#if( $pullSecret )
      imagePullSecrets:
        - name: ${pullSecret}
#end
      volumes:
        # Workspace data (PVC) â€“ this is your addition
        - name: workspace
          persistentVolumeClaim:
            claimName: ${pvcName}

      containers:
        # --- Main Theia application container ---
        - name: theia
          image: ${image}
          imagePullPolicy: ${imagePullPolicy}
          ports:
          - containerPort: ${port}
            name: application
#if( $monitorPort )
          - containerPort: ${monitorPort}
            name: monitor
#end
          resources:
            requests:
              cpu: ${requestsCpu}
              memory: ${requestsMemory}
            limits:
              cpu: ${limitsCpu}
              memory: ${limitsMemory}
          env:
#foreach($env in $envs)
              - name: $env.name
                value: "$env.value"
#end
          # pull envs from configmaps/secrets defined in Session spec
#if( $envVarsFromConfigMaps || $envVarsFromSecrets )
          envFrom:
#foreach($cm in $envVarsFromConfigMaps)
              - configMapRef:
                  name: $cm
#end
#foreach($sec in $envVarsFromSecrets)
              - secretRef:
                  name: $sec
#end
#end
          volumeMounts:
            - name: workspace
              mountPath: ${mountPath}
          securityContext:
            runAsUser: ${runAsUid}
            runAsGroup: ${runAsUid}
